<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS Styling */
        body { background: #0b141a; color: #e9edef; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #202c33; padding: 15px; display: flex; align-items: center; border-bottom: 1px solid #333; }
        .back-btn { color: white; text-decoration: none; margin-right: 15px; font-size: 20px; }
        
        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 10px; font-size: 15px; word-wrap: break-word; }
        .msg-out { background: #005c4b; align-self: flex-end; border-top-right-radius: 0; }
        .msg-in { background: #202c33; align-self: flex-start; border-top-left-radius: 0; }
        .time { font-size: 10px; opacity: 0.7; text-align: right; display: block; margin-top: 5px; }

        .input-area { background: #202c33; padding: 10px; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border-radius: 20px; border: none; background: #2a3942; color: white; font-size: 16px; }
        button { padding: 12px 15px; background: #00a884; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <a href="dashboard.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
        <div style="display:flex; flex-direction:column;">
            <h3 id="chat-title" style="margin:0; font-size:16px;">User</h3>
            <span style="font-size:12px; color:#00a884;">Online</span>
        </div>
    </div>

    <!-- Messages Box -->
    <div class="chat-area" id="msg-box"></div>

    <!-- Input Box -->
    <div class="input-area">
        <input type="text" id="msg-in" placeholder="Type a message...">
        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const currentUser = localStorage.getItem('gc_session');
        
        // URL se "to" parameter read karna
        const params = new URLSearchParams(window.location.search);
        const chatPartner = params.get('to');

        // Security Check
        if (!currentUser || !chatPartner) {
            alert("Error: User not login or Partner missing");
            window.location.href = 'dashboard.html';
        }

        // Title set karein
        document.getElementById('chat-title').innerText = chatPartner;

        // Unique Chat ID banana (e.g. "Ali_Khan" ya "Khan_Ali" -> same ID honi chahiye)
        // Sort isliye karte hain taaki dono taraf same key bane
        const chatID = [currentUser, chatPartner].sort().join('_');
        const storageKey = 'gc_msgs_' + chatID;

        // --- 2. SEND MESSAGE FUNCTION ---
        function sendMessage() {
            const inputField = document.getElementById('msg-in');
            const text = inputField.value.trim();

            if (!text) return; // Agar khali hai to kuch na kare

            // Purane messages nikalo
            let messages = JSON.parse(localStorage.getItem(storageKey) || "[]");

            // Naya message add karo
            const newMessage = {
                sender: currentUser,
                text: text,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            };

            messages.push(newMessage);

            // Wapis save karo LocalStorage mein
            localStorage.setItem(storageKey, JSON.stringify(messages));

            // Input khali karo
            inputField.value = "";

            // Screen par dikhao
            renderMessages();
        }

        // --- 3. DISPLAY MESSAGES FUNCTION ---
        function renderMessages() {
            const messages = JSON.parse(localStorage.getItem(storageKey) || "[]");
            const msgBox = document.getElementById('msg-box');

            // Agar messages count same hai to dubara render na kare (Flickering rokne ke liye)
            if (msgBox.childElementCount === messages.length) return;

            msgBox.innerHTML = ""; // Box clear karo

            messages.forEach(msg => {
                const div = document.createElement('div');
                // Check karo message maine bheja ya dost ne
                const isMe = msg.sender === currentUser;
                
                div.className = `msg ${isMe ? 'msg-out' : 'msg-in'}`;
                div.innerHTML = `
                    ${msg.text}
                    <span class="time">${msg.time}</span>
                `;
                msgBox.appendChild(div);
            });

            // Scroll to bottom (Latest message dikhane ke liye)
            msgBox.scrollTop = msgBox.scrollHeight;
        }

        // --- 4. AUTO REFRESH (Har 1 second mein check karega) ---
        renderMessages(); // Pehli baar load karo
        setInterval(renderMessages, 1000); // Har 1 second baad refresh

        // Enter key dabane par send ho
        document.getElementById('msg-in').addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });

    </script>
</body>
</html>
