<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #0b141a; color: #e9edef; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #202c33; padding: 15px; display: flex; align-items: center; border-bottom: 1px solid #333; }
        .back-btn { color: white; text-decoration: none; margin-right: 15px; font-size: 20px; }
        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .msg { max-width: 70%; padding: 10px 15px; margin-bottom: 5px; border-radius: 10px; font-size: 15px; }
        .msg-out { background: #005c4b; align-self: flex-end; border-top-right-radius: 0; }
        .msg-in { background: #202c33; align-self: flex-start; border-top-left-radius: 0; }
        .input-area { background: #202c33; padding: 10px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 20px; border: none; background: #2a3942; color: white; }
        button { padding: 10px 15px; background: #00a884; color: white; border: none; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <a href="dashboard.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
        <h3 id="chat-title" style="margin:0;">User</h3>
    </div>

    <div class="chat-area" id="msg-box"></div>

    <div class="input-area">
        <input type="text" id="msg-in" placeholder="Type a message...">
        <button onclick="send()"><i class="fas fa-paper-plane"></i></button>
    </div>

    <script>
        const user = localStorage.getItem('gc_session');
        // URL se "to" ki value nikalo (e.g. ?to=Ali)
        const params = new URLSearchParams(window.location.search);
        const target = params.get('to');

        if (!user || !target) window.location.href = 'dashboard.html';
        
        document.getElementById('chat-title').innerText = target;
        const chatID = [user, target].sort().join('_'); // Unique ID for chat

        function send() {
            const txt = document.getElementById('msg-in').value.trim();
            if(!txt) return;

            let msgs = JSON.parse(localStorage.getItem('gc_msgs_' + chatID) || "[]");
            msgs.push({ s: user, t: txt });
            localStorage.setItem('gc_msgs_' + chatID, JSON.stringify(msgs));
            
            document.getElementById('msg-in').value = "";
            render();
        }

        function render() {
            const msgs = JSON.parse(localStorage.getItem('gc_msgs_' + chatID) || "[]");
            const box = document.getElementById('msg-box');
            // Check if new message arrived to avoid flicker
            if(box.childElementCount === msgs.length) return;

            box.innerHTML = "";
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.s === user ? 'msg-out' : 'msg-in'}`;
                div.innerText = m.t;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        }

        render();
        setInterval(render, 1000); // Auto refresh
    </script>
</body>
</html>
