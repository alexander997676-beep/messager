<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Link - Premium</title>
    <!-- Modern Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- PREMIUM CSS --- */
        :root {
            --primary: #4A90E2;
            --accent: #50E3C2;
            --dark: #2C3E50;
            --light: #ECF0F1;
            --glass: rgba(255, 255, 255, 0.95);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .app-container {
            background: var(--glass);
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        h2 { text-align: center; color: var(--dark); margin-bottom: 5px; }
        p.subtitle { text-align: center; color: #7f8c8d; font-size: 0.9rem; margin-bottom: 25px; }

        /* Form Styling */
        .form-group { margin-bottom: 15px; position: relative; }
        
        input, textarea {
            width: 100%;
            padding: 14px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            box-sizing: border-box;
            font-family: inherit;
            transition: 0.3s;
            background: #f9f9f9;
        }

        input:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            background: white;
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.1);
        }

        /* Profile Pic Upload */
        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid var(--primary);
            background-color: #eee;
            background-image: url('https://cdn-icons-png.flaticon.com/512/847/847969.png');
            background-size: cover;
            background-position: center;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.3s;
        }
        .avatar-preview:hover { transform: scale(1.05); }
        .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
        input[type="file"] { display: none; }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            font-size: 1rem;
        }
        .btn-primary { background: linear-gradient(to right, #4A90E2, #50E3C2); color: white; box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-text { background: none; color: var(--primary); font-size: 0.9rem; margin-top: 15px; }

        /* Helpers */
        .hidden { display: none !important; }
        
        /* Dashboard & Messages */
        .link-box {
            background: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 10px;
            border: 1px dashed #1565c0;
            word-break: break-all;
            text-align: center;
            font-size: 0.85rem;
            margin: 15px 0;
        }

        .msg-list { max-height: 350px; overflow-y: auto; margin-top: 20px; }
        .msg-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-left: 5px solid var(--accent);
        }

        /* Custom Toast Notification */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            z-index: 1000;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
        }
        .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- === LOGIN FORM === -->
        <div id="section-login">
            <h2>Welcome Back</h2>
            <p class="subtitle">Sign in to check your secret messages</p>
            
            <!-- FORM tag is essential for Browser Password Manager -->
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <!-- autocomplete="username" helps browser identify user field -->
                    <input type="text" id="log-user" name="username" placeholder="Username" autocomplete="username" required>
                </div>
                <div class="form-group">
                    <!-- autocomplete="current-password" helps browser fill password -->
                    <input type="password" id="log-pass" name="password" placeholder="Password" autocomplete="current-password" required>
                </div>
                <button type="submit" class="btn btn-primary">Sign In</button>
            </form>

            <button class="btn btn-text" onclick="switchView('signup')">New here? Create Account</button>
        </div>

        <!-- === SIGN UP FORM === -->
        <div id="section-signup" class="hidden">
            <h2>Create Account</h2>
            <p class="subtitle">Get your own anonymous link</p>

            <form id="signupForm" onsubmit="handleRegister(event)">
                <!-- Profile Pic -->
                <div class="avatar-upload" onclick="document.getElementById('reg-pic').click()">
                    <div class="avatar-preview" id="avatar-preview-box">
                        <img id="avatar-img" class="hidden">
                    </div>
                    <span style="font-size:12px; color:#888; margin-top:5px;">Tap to add photo</span>
                    <input type="file" id="reg-pic" accept="image/*" onchange="previewImage()">
                </div>

                <div class="form-group">
                    <!-- autocomplete="username" tells browser this is a new user -->
                    <input type="text" id="reg-user" name="username" placeholder="Choose a Username" autocomplete="username" required>
                </div>
                <div class="form-group">
                    <!-- autocomplete="new-password" tells browser to save this new password -->
                    <input type="password" id="reg-pass" name="password" placeholder="Create Password" autocomplete="new-password" required>
                </div>
                <button type="submit" class="btn btn-primary">Sign Up & Save</button>
            </form>

            <button class="btn btn-text" onclick="switchView('login')">Already have an account? Sign In</button>
        </div>

        <!-- === DASHBOARD === -->
        <div id="section-dashboard" class="hidden">
            <h2>My Inbox</h2>
            <p class="subtitle" id="dash-user">Logged in</p>

            <div class="link-box" id="my-link">Generating...</div>
            <button class="btn btn-primary" onclick="copyLink()">Copy Link</button>

            <div style="margin-top:20px; text-align:left;">
                <h4 style="margin-bottom:10px;">Messages Received:</h4>
                <div id="msg-list" class="msg-list">
                    <!-- Messages go here -->
                </div>
            </div>

            <button class="btn btn-text" style="color:red;" onclick="logout()">Log Out</button>
        </div>

        <!-- === PUBLIC MESSAGE SENDER === -->
        <div id="section-public" class="hidden">
            <div class="avatar-upload">
                <div class="avatar-preview" style="cursor:default; border-color:var(--accent);">
                    <img id="public-img" src="" class="hidden" style="display:block;">
                </div>
            </div>
            <h2>Send Message</h2>
            <p class="subtitle">To: <b id="public-name">User</b> (Anonymous)</p>

            <textarea id="secret-msg" rows="4" placeholder="Type your secret message here..."></textarea>
            
            <button class="btn btn-primary" onclick="sendMessage()">Send Message</button>
            <button class="btn btn-text" onclick="window.location.href = window.location.pathname">Get your own link</button>
        </div>

    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Notification</div>

    <script>
        // --- CONFIG & STATE ---
        const API_USERS = 'users_db_v2'; 
        const API_MSGS = 'msgs_db_v2';
        
        // --- NAVIGATION LOGIC ---
        const urlParams = new URLSearchParams(window.location.search);
        const sendTo = urlParams.get('to');

        window.onload = () => {
            if(sendTo) {
                loadPublicPage(sendTo);
            } else {
                checkSession();
            }
        };

        function switchView(viewName) {
            ['section-login', 'section-signup', 'section-dashboard', 'section-public'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById('section-' + viewName).classList.remove('hidden');
        }

        // --- AUTHENTICATION (With Browser Password Saving Support) ---

        // 1. REGISTER
        function handleRegister(e) {
            e.preventDefault(); // Stop page reload
            
            const user = document.getElementById('reg-user').value.trim();
            const pass = document.getElementById('reg-pass').value.trim();
            const fileInput = document.getElementById('reg-pic');

            let users = JSON.parse(localStorage.getItem(API_USERS) || "{}");

            if (users[user]) {
                showToast("Username already exists!");
                return;
            }

            // Image handling
            let avatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.readAsDataURL(fileInput.files[0]);
                reader.onload = function(evt) {
                    saveUserToDB(user, pass, evt.target.result);
                };
            } else {
                saveUserToDB(user, pass, avatar);
            }
        }

        function saveUserToDB(user, pass, avatar) {
            let users = JSON.parse(localStorage.getItem(API_USERS) || "{}");
            users[user] = { password: pass, avatar: avatar };
            localStorage.setItem(API_USERS, JSON.stringify(users));
            
            showToast("Account Created! Redirecting...");
            
            // Logic to trigger Browser Save Password:
            // We switch to login form and autofill it, forcing browser to notice the new credential
            switchView('login');
            document.getElementById('log-user').value = user;
            document.getElementById('log-pass').value = pass;
            // Note: User still needs to click Login once, which usually confirms the "Save" prompt
        }

        // 2. LOGIN
        function handleLogin(e) {
            e.preventDefault();
            
            const user = document.getElementById('log-user').value.trim();
            const pass = document.getElementById('log-pass').value.trim();
            
            let users = JSON.parse(localStorage.getItem(API_USERS) || "{}");

            if(users[user] && users[user].password === pass) {
                localStorage.setItem('active_session', user);
                showToast("Login Successful!");
                showDashboard(user);
            } else {
                showToast("Invalid Username or Password");
            }
        }

        function checkSession() {
            const active = localStorage.getItem('active_session');
            if(active) showDashboard(active);
            else switchView('login');
        }

        function logout() {
            localStorage.removeItem('active_session');
            location.reload();
        }

        // --- DASHBOARD LOGIC ---
        function showDashboard(user) {
            switchView('dashboard');
            document.getElementById('dash-user').innerText = "Hello, " + user;
            
            const link = window.location.href.split('?')[0] + "?to=" + user;
            document.getElementById('my-link').innerText = link;

            loadMessages(user);
        }

        function loadMessages(user) {
            let allMsgs = JSON.parse(localStorage.getItem(API_MSGS) || "{}");
            let userMsgs = allMsgs[user] || [];
            
            const list = document.getElementById('msg-list');
            list.innerHTML = "";
            
            if(userMsgs.length === 0) list.innerHTML = "<p style='color:#999; text-align:center'>No messages yet.</p>";

            userMsgs.reverse().forEach(msg => {
                let div = document.createElement('div');
                div.className = 'msg-card';
                div.innerHTML = `
                    <div style="font-size:15px; color:#333;">${msg.text}</div>
                    <div style="font-size:11px; color:#888; text-align:right; margin-top:5px;">${msg.date}</div>
                `;
                list.appendChild(div);
            });
        }

        function copyLink() {
            const txt = document.getElementById('my-link').innerText;
            navigator.clipboard.writeText(txt);
            showToast("Link Copied to Clipboard!");
        }

        // --- PUBLIC SENDER LOGIC ---
        function loadPublicPage(user) {
            let users = JSON.parse(localStorage.getItem(API_USERS) || "{}");
            if(!users[user]) {
                document.body.innerHTML = "<h2 style='text-align:center; color:white;'>User Not Found</h2>";
                return;
            }
            
            switchView('public');
            document.getElementById('public-name').innerText = user;
            document.getElementById('public-img').src = users[user].avatar;
        }

        function sendMessage() {
            const txt = document.getElementById('secret-msg').value.trim();
            if(!txt) return showToast("Message is empty!");

            let allMsgs = JSON.parse(localStorage.getItem(API_MSGS) || "{}");
            if(!allMsgs[sendTo]) allMsgs[sendTo] = [];

            allMsgs[sendTo].push({
                text: txt,
                date: new Date().toLocaleString()
            });

            localStorage.setItem(API_MSGS, JSON.stringify(allMsgs));
            showToast("Message Sent Successfully!");
            document.getElementById('secret-msg').value = "";
        }

        // --- UTILS ---
        function previewImage() {
            const file = document.getElementById('reg-pic').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('avatar-img').src = e.target.result;
                    document.getElementById('avatar-img').classList.remove('hidden');
                    document.getElementById('avatar-preview-box').style.backgroundImage = 'none';
                }
                reader.readAsDataURL(file);
            }
        }

        function showToast(message) {
            const x = document.getElementById("toast");
            x.innerText = message;
            x.className = "toast show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }
    </script>
</body>
</html>
