<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FaizanMsg Ultimate Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME & UTILS --- */
        :root {
            --bg: #000; --surface: #121212; --surface-light: #1e1e1e;
            --accent: #8b5cf6; --accent-grad: linear-gradient(135deg, #8b5cf6, #ec4899);
            --text: #fff; --text-sub: #9ca3af;
            --glass: rgba(255, 255, 255, 0.08);
            --font: 'Outfit', sans-serif;
        }

        * { box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font); background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; justify-content: center; overflow: hidden; }

        .app-container { width: 100%; max-width: 480px; height: 100%; position: relative; display: flex; flex-direction: column; background: #050505; }
        .scroll-view { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; scroll-behavior: smooth; }
        
        /* --- CARDS & INPUTS --- */
        .card { background: var(--surface); border: 1px solid var(--glass); padding: 15px; border-radius: 20px; margin-bottom: 15px; position: relative; }
        .input-field { width: 100%; background: var(--surface-light); border: 1px solid transparent; padding: 15px; border-radius: 15px; color: white; margin-bottom: 10px; }
        .btn { width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; background: var(--accent-grad); color: white; }
        
        /* --- PROFILE UPLOAD CIRCLE --- */
        .profile-upload {
            width: 100px; height: 100px; border-radius: 50%; background: var(--surface-light);
            border: 2px dashed var(--accent); margin: 0 auto 20px; display: flex; 
            align-items: center; justify-content: center; overflow: hidden; position: relative; cursor: pointer;
        }
        .profile-upload img { width: 100%; height: 100%; object-fit: cover; }
        .profile-upload i { font-size: 24px; color: var(--text-sub); }
        
        .user-avatar {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover; 
            border: 3px solid var(--accent); margin: 0 auto 15px; display: block; background: #333;
        }

        /* --- MEDIA UPLOAD BUTTONS --- */
        .media-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .media-btn {
            flex: 1; padding: 15px; background: var(--surface-light); border: 1px solid var(--glass);
            border-radius: 15px; color: var(--text-sub); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; cursor: pointer; transition: 0.3s;
        }
        .media-btn.selected { border-color: var(--accent); color: var(--accent); background: rgba(139, 92, 246, 0.1); }
        
        /* --- PLAYERS --- */
        .msg-media { width: 100%; border-radius: 12px; margin-top: 10px; border: 1px solid var(--glass); }
        video.msg-media, audio.msg-media { outline: none; background: #000; }
        
        /* --- NAV & UTILS --- */
        .dock-nav { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(20,20,20,0.9); padding: 12px 30px; border-radius: 50px; display: flex; gap: 40px; border: 1px solid var(--glass); z-index: 50; }
        .dock-item { font-size: 22px; color: #666; transition: 0.3s; }
        .dock-item.active { color: var(--accent); transform: translateY(-5px); }

        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
        
        .hidden { display: none !important; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: white; color: black; padding: 10px 20px; border-radius: 30px; font-weight: bold; opacity: 0; transition: 0.3s; z-index: 100; pointer-events: none; }
        .toast.show { opacity: 1; }

        #preview-area { margin-bottom: 15px; text-align: center; }
        .preview-thumb { max-height: 150px; border-radius: 10px; max-width: 100%; }

    </style>
</head>
<body>

<div class="app-container">

    <!-- 1. AUTH SCREEN -->
    <div id="view-auth" class="view-section active">
        <div class="scroll-view" style="display:flex; flex-direction:column; justify-content:center;">
            <h1 style="text-align:center; margin-bottom:20px;">FaizanMsg <span style="color:var(--accent)">Ultimate</span></h1>
            
            <div id="form-box">
                <!-- Profile Pic Upload (Hidden by default, shown in Signup) -->
                <div id="auth-pic-wrapper" class="hidden">
                    <label class="profile-upload">
                        <img id="auth-pic-preview" class="hidden">
                        <i id="auth-pic-icon" class="fas fa-camera"></i>
                        <input type="file" id="auth-pic-input" accept="image/*" style="display:none" onchange="app.handleAuthPic(this)">
                    </label>
                    <p style="text-align:center; font-size:12px; color:#666; margin-bottom:15px;">Set Profile Photo</p>
                </div>

                <input type="email" id="auth-email" class="input-field" placeholder="Email">
                <input type="text" id="auth-user" class="input-field hidden" placeholder="Username">
                <input type="password" id="auth-pass" class="input-field" placeholder="Password">
                
                <button id="btn-login" class="btn" onclick="app.login()">Login</button>
                <button id="btn-signup" class="btn hidden" onclick="app.register()">Sign Up</button>
                
                <p style="text-align:center; margin-top:20px; font-size:14px; color:#888;">
                    <span id="auth-toggle-text">New here?</span> 
                    <a href="#" onclick="app.toggleAuth()" style="color:white;">Click here</a>
                </p>
            </div>
        </div>
    </div>

    <!-- 2. INBOX -->
    <div id="view-inbox" class="view-section">
        <div class="scroll-view">
            <h2 style="margin-bottom:20px;">Inbox <i class="fas fa-sync" style="float:right; font-size:16px; opacity:0.5;" onclick="app.renderInbox()"></i></h2>
            <div id="msg-list"></div>
        </div>
    </div>

    <!-- 3. PUBLIC SEND -->
    <div id="view-public" class="view-section">
        <div class="scroll-view">
            <div style="text-align:center; margin-bottom:30px;">
                <!-- Target User Image -->
                <img id="pub-img" src="" class="user-avatar" alt="User">
                <h2 style="font-size:24px;">Send Secret</h2>
                <p style="color:#666;">To <span id="pub-target" style="color:white; font-weight:bold;">User</span></p>
            </div>

            <!-- MEDIA BUTTONS -->
            <div class="media-bar">
                <label class="media-btn" id="btn-img">
                    <i class="fas fa-image"></i> <span>Photo</span>
                    <input type="file" accept="image/*" onchange="app.handleFile(this, 'image')">
                </label>
                <label class="media-btn" id="btn-vid">
                    <i class="fas fa-video"></i> <span>Video</span>
                    <input type="file" accept="video/*" onchange="app.handleFile(this, 'video')">
                </label>
                <label class="media-btn" id="btn-aud">
                    <i class="fas fa-microphone"></i> <span>Audio</span>
                    <input type="file" accept="audio/*" onchange="app.handleFile(this, 'audio')">
                </label>
            </div>

            <!-- PREVIEW -->
            <div id="preview-area" class="hidden">
                <div id="preview-content"></div>
                <div id="file-name" style="font-size:12px; color:var(--accent); margin-top:5px;"></div>
                <button onclick="app.clearFile()" style="background:none; border:none; color:red; margin-top:5px;">Remove File</button>
            </div>

            <textarea id="msg-text" class="input-field" rows="4" placeholder="Type a message..."></textarea>
            <button class="btn" onclick="app.sendMessage()">Send Message ðŸš€</button>
            <br><br>
            <center><a href="?" style="color:#555; text-decoration:none; font-size:12px;">Create Account</a></center>
        </div>
    </div>

    <!-- 4. PROFILE -->
    <div id="view-profile" class="view-section">
        <div class="scroll-view">
            <div class="card" style="text-align:center;">
                <!-- User Profile Pic -->
                <img id="p-img" src="" class="user-avatar">
                
                <h2 id="p-user">User</h2>
                <p id="p-email" style="color:#666; font-size:12px;">Email</p>
            </div>
            <div class="card">
                <p style="font-size:12px; color:#666;">Your Link:</p>
                <div id="p-link" style="color:var(--accent); font-family:monospace; margin:5px 0; overflow:hidden; text-overflow:ellipsis;">...</div>
                <button class="btn" onclick="app.copyLink()" style="padding:10px; font-size:14px; margin-top:10px;">Copy Link</button>
            </div>
            <button class="btn" onclick="app.logout()" style="background:#330000; color:#ff4444;">Log Out</button>
        </div>
    </div>

    <!-- NAV -->
    <div id="nav-dock" class="dock-nav hidden">
        <i class="fas fa-envelope dock-item active" onclick="app.nav('inbox')"></i>
        <i class="fas fa-user dock-item" onclick="app.nav('profile')"></i>
    </div>

</div>

<div id="toast" class="toast">Alert</div>

<script>
    // --- INDEXED DB HELPER ---
    const DB_NAME = 'FaizanMsgUltimateDB';
    const DB_VER = 1;
    const DEFAULT_PIC = 'https://cdn-icons-png.flaticon.com/512/847/847969.png';

    const db = {
        open: () => {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VER);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('users')) db.createObjectStore('users', { keyPath: 'email' });
                    if (!db.objectStoreNames.contains('messages')) db.createObjectStore('messages', { autoIncrement: true });
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        },
        put: async (store, data) => {
            const d = await db.open();
            return new Promise((resolve, reject) => {
                const tx = d.transaction(store, 'readwrite');
                const req = tx.objectStore(store).put(data);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        },
        get: async (store, key) => {
            const d = await db.open();
            return new Promise((resolve, reject) => {
                const tx = d.transaction(store, 'readonly');
                const req = tx.objectStore(store).get(key);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        },
        getAll: async (store) => {
            const d = await db.open();
            return new Promise((resolve, reject) => {
                const tx = d.transaction(store, 'readonly');
                const req = tx.objectStore(store).getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }
    };

    // --- MAIN APP ---
    const app = {
        state: { user: null, email: null, file: null, fileType: null, authFile: null },

        init: async () => {
            const params = new URLSearchParams(window.location.search);
            const to = params.get('to');

            if(to) {
                app.loadPublic(to);
            } else {
                const u = localStorage.getItem('f_user');
                const e = localStorage.getItem('f_email');
                if(u && e) {
                    app.state.user = u;
                    app.state.email = e;
                    app.nav('inbox');
                }
            }
        },

        // --- AUTH PIC HANDLING ---
        handleAuthPic: (input) => {
            const file = input.files[0];
            if(file) {
                app.state.authFile = file;
                const url = URL.createObjectURL(file);
                document.getElementById('auth-pic-preview').src = url;
                document.getElementById('auth-pic-preview').classList.remove('hidden');
                document.getElementById('auth-pic-icon').classList.add('hidden');
            }
        },

        // --- AUTH & NAV ---
        toggleAuth: () => {
            const isLogin = !document.getElementById('auth-user').classList.contains('hidden');
            if(isLogin) {
                // Switch to Login
                document.getElementById('auth-pic-wrapper').classList.add('hidden');
                document.getElementById('auth-user').classList.add('hidden');
                document.getElementById('btn-signup').classList.add('hidden');
                document.getElementById('btn-login').classList.remove('hidden');
                document.getElementById('auth-toggle-text').innerText = "New here?";
            } else {
                // Switch to Signup
                document.getElementById('auth-pic-wrapper').classList.remove('hidden');
                document.getElementById('auth-user').classList.remove('hidden');
                document.getElementById('btn-signup').classList.remove('hidden');
                document.getElementById('btn-login').classList.add('hidden');
                document.getElementById('auth-toggle-text').innerText = "Have account?";
            }
        },

        register: async () => {
            const email = document.getElementById('auth-email').value.toLowerCase();
            const user = document.getElementById('auth-user').value;
            const pass = document.getElementById('auth-pass').value;
            
            if(!email || !user || !pass) return app.toast("Fill all fields");

            const exists = await db.get('users', email);
            if(exists) return app.toast('Email taken');

            // Save user with profile pic (as Blob)
            const userData = { 
                email, 
                username: user, 
                password: pass,
                pic: app.state.authFile // Storing heavy image in IndexedDB
            };

            await db.put('users', userData);
            app.toast('Created! Please Login.');
            app.toggleAuth();
        },

        login: async () => {
            const email = document.getElementById('auth-email').value.toLowerCase();
            const pass = document.getElementById('auth-pass').value;
            const u = await db.get('users', email);

            if(u && u.password === pass) {
                localStorage.setItem('f_user', u.username);
                localStorage.setItem('f_email', email);
                app.state.user = u.username;
                app.state.email = email;
                app.nav('inbox');
            } else app.toast('Invalid Details');
        },

        logout: () => { localStorage.clear(); location.reload(); },

        nav: (v) => {
            document.querySelectorAll('.view-section').forEach(x => x.classList.remove('active'));
            document.getElementById(`view-${v}`).classList.add('active');
            
            const dock = document.getElementById('nav-dock');
            
            if(v === 'inbox' || v === 'profile') {
                dock.classList.remove('hidden');
                if(v === 'inbox') app.renderInbox();
                if(v === 'profile') app.renderProfile();
            } else {
                dock.classList.add('hidden');
            }
        },

        // --- PROFILE DISPLAY ---
        renderProfile: async () => {
            // Get user data from DB to show Pic
            const u = await db.get('users', app.state.email);
            
            document.getElementById('p-user').innerText = '@' + app.state.user;
            document.getElementById('p-email').innerText = app.state.email;
            document.getElementById('p-link').innerText = window.location.origin + window.location.pathname + "?to=" + app.state.user;

            const imgEl = document.getElementById('p-img');
            if(u && u.pic) {
                imgEl.src = URL.createObjectURL(u.pic);
            } else {
                imgEl.src = DEFAULT_PIC;
            }
        },

        // --- PUBLIC VIEW ---
        loadPublic: async (to) => {
            app.nav('public');
            document.getElementById('pub-target').innerText = to;
            
            // Find target user by username to show their pic
            const allUsers = await db.getAll('users');
            const targetUser = allUsers.find(u => u.username === to);
            
            const imgEl = document.getElementById('pub-img');
            if(targetUser && targetUser.pic) {
                imgEl.src = URL.createObjectURL(targetUser.pic);
            } else {
                imgEl.src = DEFAULT_PIC;
            }
        },

        // --- MEDIA SENDING ---
        handleFile: (input, type) => {
            const file = input.files[0];
            if (!file) return;

            app.state.file = file;
            app.state.fileType = type;

            document.querySelectorAll('.media-btn').forEach(b => b.classList.remove('selected'));
            input.parentElement.classList.add('selected');
            
            const area = document.getElementById('preview-area');
            const content = document.getElementById('preview-content');
            const name = document.getElementById('file-name');
            
            area.classList.remove('hidden');
            name.innerText = `${type.toUpperCase()}: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
            content.innerHTML = '';

            if (type === 'image') {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'preview-thumb';
                content.appendChild(img);
            } else if (type === 'video') {
                const vid = document.createElement('video');
                vid.src = URL.createObjectURL(file);
                vid.className = 'preview-thumb';
                vid.controls = true;
                content.appendChild(vid);
            } else {
                content.innerHTML = '<i class="fas fa-music" style="font-size:40px; color:#fff;"></i>';
            }
        },

        clearFile: () => {
            app.state.file = null;
            app.state.fileType = null;
            document.getElementById('preview-area').classList.add('hidden');
            document.querySelectorAll('.media-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('input[type="file"]').forEach(i => i.value = "");
        },

        sendMessage: async () => {
            const text = document.getElementById('msg-text').value;
            const target = document.getElementById('pub-target').innerText;

            if (!text && !app.state.file) return app.toast('Empty Message');

            const msgData = {
                to: target,
                text: text,
                media: app.state.file,
                type: app.state.fileType,
                date: new Date()
            };

            await db.put('messages', msgData);

            app.toast('Sent Successfully!');
            setTimeout(() => location.href = window.location.pathname, 1500);
        },

        renderInbox: async () => {
            const allMsgs = await db.getAll('messages');
            const myMsgs = allMsgs.filter(m => m.to === app.state.user);
            const list = document.getElementById('msg-list');
            list.innerHTML = myMsgs.length ? '' : '<div style="text-align:center; margin-top:50px; opacity:0.5">No Messages</div>';

            myMsgs.reverse().forEach(m => {
                let mediaHtml = '';
                if (m.media) {
                    const url = URL.createObjectURL(m.media);
                    if (m.type === 'image') mediaHtml = `<img src="${url}" class="msg-media">`;
                    else if (m.type === 'video') mediaHtml = `<video src="${url}" controls class="msg-media"></video>`;
                    else if (m.type === 'audio') mediaHtml = `<audio src="${url}" controls class="msg-media"></audio>`;
                }

                const d = document.createElement('div');
                d.className = 'card';
                d.innerHTML = `
                    <div style="font-size:12px; color:var(--accent); font-weight:bold;">SECRET</div>
                    ${mediaHtml}
                    <p style="margin-top:10px; font-size:16px;">${m.text}</p>
                    <div style="font-size:10px; opacity:0.5; margin-top:5px; text-align:right;">${new Date(m.date).toLocaleTimeString()}</div>
                `;
                list.appendChild(d);
            });
        },

        copyLink: () => { navigator.clipboard.writeText(document.getElementById('p-link').innerText); app.toast('Copied!'); },
        toast: (m) => { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
    };

    window.onload = app.init;
</script>
</body>
</html>
